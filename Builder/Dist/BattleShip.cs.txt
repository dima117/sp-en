//7/24/2024 12:00:36 AM
public class Grid{readonly IMyGridTerminalSystem system;public Grid(IMyGridTerminalSystem system){this.system=system;}public IMyBlockGroup[]GetBlockGroups(string prefix=""){var groups=new List<IMyBlockGroup>();system.GetBlockGroups(groups,g=>g.Name.StartsWith(prefix,StringComparison.OrdinalIgnoreCase));return groups.ToArray();}public T[]GetBlocksOfType<T>(Func<T,bool>filter=null)where T:class,IMyTerminalBlock{var list=new List<T>();system.GetBlocksOfType(list,filter);return list.ToArray();}public T GetBlockWithName<T>(string name)where T:class,IMyTerminalBlock{return system.GetBlockWithName(name)as T;}public IMyCameraBlock GetCamera(string name){var camera=GetBlockWithName<IMyCameraBlock>(name);if(camera!=null){camera.Enabled=true;camera.EnableRaycast=true;}return camera;}public IMySmallMissileLauncherReload[]GetLargeRailguns(Func<IMySmallMissileLauncherReload,bool>filter=null){return GetBlocksOfType<IMySmallMissileLauncherReload>(b=>b.BlockDefinition.SubtypeId=="LargeRailgun"&&(filter==null||filter(b))).ToArray();}public IMySmallMissileLauncher[]GetArtillery(Func<IMySmallMissileLauncher,bool>filter=null){return GetBlocksOfType<IMySmallMissileLauncher>(b=>b.BlockDefinition.SubtypeId=="LargeBlockLargeCalibreGun"&&(filter==null||filter(b))).ToArray();}public IMyLargeMissileTurret[]GetArtilleryTurrets(Func<IMyLargeMissileTurret,bool>filter=null){return GetBlocksOfType<IMyLargeMissileTurret>(b=>b.BlockDefinition.SubtypeId=="LargeCalibreTurret"&&(filter==null||filter(b))).ToArray();}public IMySoundBlock GetSound(string name,string soundName="SoundBlockAlert2"){var sound=GetBlockWithName<IMySoundBlock>(name);if(sound!=null){sound.Enabled=true;sound.SelectedSound=soundName;sound.Volume=1;sound.Range=100;}return sound;}public T GetByFilterOrAny<T>(Func<T,bool>filter=null,Action<T>init=null)where T:class,IMyTerminalBlock{var all=new List<T>();system.GetBlocksOfType(all,filter);T res=null;if(filter!=null){res=all.FirstOrDefault(filter);}if(res==null){res=all.FirstOrDefault();}if(res!=null&&init!=null){init(res);}return res;}}public class LocalTime{private const double oneTickMs=1000/60;private IMyGridProgramRuntimeInfo runtime;private DateTime initial;private long currentTick=0;private TimeSpan offset=TimeSpan.Zero;private DateTime now;private double avg=0;public DateTime Now=>now;public long CurrentTick=>currentTick;public double Avg=>avg;public LocalTime(IMyGridProgramRuntimeInfo runtime,DateTime?initial=null){this.initial=initial??DateTime.MinValue;this.runtime=runtime;}public DateTime Update(UpdateType updateSource){if((updateSource&UpdateType.Update1)==UpdateType.Update1){avg=avg*0.99+runtime.LastRunTimeMs*0.01;currentTick++;offset=TimeSpan.Zero;}else{offset+=runtime.TimeSinceLastRun;}now=initial.AddMilliseconds(currentTick*oneTickMs)+offset;return now;}}public class CenterOfMassPosition{public CenterOfMassPosition(Vector3D local,Vector3D world){Local=local;World=world;}public readonly Vector3D Local;public readonly Vector3D World;}public class CenterOfMass{public CenterOfMass(CenterOfMassPosition physicalValue,CenterOfMassPosition virtualValue){Physical=physicalValue;Virtual=virtualValue;}public readonly CenterOfMassPosition Physical;public readonly CenterOfMassPosition Virtual;}public class GravityDrive{readonly IMyShipController controller;readonly List<IMyVirtualMass>massBlocks=new List<IMyVirtualMass>();readonly List<IMyGravityGeneratorBase>allGens=new List<IMyGravityGeneratorBase>();readonly List<IMyGravityGeneratorBase>upGens=new List<IMyGravityGeneratorBase>();readonly List<IMyGravityGeneratorBase>downGens=new List<IMyGravityGeneratorBase>();readonly List<IMyGravityGeneratorBase>leftGens=new List<IMyGravityGeneratorBase>();readonly List<IMyGravityGeneratorBase>rightGens=new List<IMyGravityGeneratorBase>();readonly List<IMyGravityGeneratorBase>forwardGens=new List<IMyGravityGeneratorBase>();readonly List<IMyGravityGeneratorBase>backwardGens=new List<IMyGravityGeneratorBase>();const float GRAVITY_RATIO=9.8f;const float DAMPENERS_RATIO=0.1f;bool isActive;public GravityDrive(IMyShipController cockpit,IMyBlockGroup group){controller=cockpit;group.GetBlocksOfType(massBlocks,b=>b.IsSameConstructAs(cockpit));group.GetBlocksOfType(allGens,b=>b.IsSameConstructAs(cockpit));foreach(var block in allGens){if(cockpit.WorldMatrix.Forward==block.WorldMatrix.Down)forwardGens.Add(block);else if(cockpit.WorldMatrix.Backward==block.WorldMatrix.Down)backwardGens.Add(block);else if(cockpit.WorldMatrix.Left==block.WorldMatrix.Down)leftGens.Add(block);else if(cockpit.WorldMatrix.Right==block.WorldMatrix.Down)rightGens.Add(block);else if(cockpit.WorldMatrix.Up==block.WorldMatrix.Down)upGens.Add(block);else if(cockpit.WorldMatrix.Down==block.WorldMatrix.Down)downGens.Add(block);}SetActiveState(false,forceUpdate:true);foreach(var b in allGens){b.Enabled=false;b.GravityAcceleration=0f;}}public CenterOfMass CalculateCenterOfMass(){var invertedMatrix=MatrixD.Invert(controller.WorldMatrix.GetOrientation());var centerOfMass=controller.CenterOfMass;var localCenterOfMass=Vector3D.Transform(centerOfMass,invertedMatrix);var virtualMassPositions=massBlocks.Aggregate(Vector3D.Zero,(a,b)=>a+b.GetPosition());var virtualCenterOfMass=virtualMassPositions/massBlocks.Count;var localVirtualCenterOfMass=Vector3D.Transform(virtualCenterOfMass,invertedMatrix);return new CenterOfMass(physicalValue:new CenterOfMassPosition(localCenterOfMass,centerOfMass),virtualValue:new CenterOfMassPosition(localVirtualCenterOfMass,virtualCenterOfMass));}public bool DampenersOverride=>controller.DampenersOverride;public void Update(){MyShipVelocities velocities=controller.GetShipVelocities();Vector3D worldVelocity=velocities.LinearVelocity;Vector3 input=controller.MoveIndicator;MatrixD matrix=MatrixD.Transpose(controller.WorldMatrix);Vector3 localVelocity=Vector3D.TransformNormal(worldVelocity,matrix);var isInUse=SetGravityAcceleration(input.X,localVelocity.X,rightGens,leftGens);isInUse|=SetGravityAcceleration(input.Y,localVelocity.Y,upGens,downGens);isInUse|=SetGravityAcceleration(input.Z,localVelocity.Z,backwardGens,forwardGens);SetActiveState(isInUse);}private void SetActiveState(bool isActive,bool forceUpdate=false){if(isActive!=this.isActive||forceUpdate){this.isActive=isActive;foreach(IMyVirtualMass b in massBlocks){b.Enabled=isActive;}}}private bool IsZero(float value)=>Math.Abs(value)<0.00001;private bool SetGravityAcceleration(float input,float velocity,IList<IMyGravityGeneratorBase>positive,IList<IMyGravityGeneratorBase>negative){var value=IsZero(input)&&DampenersOverride?-velocity*DAMPENERS_RATIO:input;var isInUse=!IsZero(value);var acceleration=isInUse?value*GRAVITY_RATIO:0;foreach(var x in positive){x.GravityAcceleration=acceleration;x.Enabled=isInUse;}foreach(var x in negative){x.GravityAcceleration=-acceleration;x.Enabled=isInUse;}return isInUse;}}public static class Helpers{public class InterceptResult{public Vector3D Position;public double TimeMs;}public static InterceptResult CalculateInterceptPoint(Vector3D ownPosition,double interceptSpeed,Vector3D targetPosition,Vector3D targetVelocity){Vector3D directionToTarget=Vector3D.Normalize(targetPosition-ownPosition);double targetSpeedlOrth=Vector3D.Dot(targetVelocity,directionToTarget);Vector3D targetVelOrth=directionToTarget*targetSpeedlOrth;Vector3D targetVelTang=targetVelocity-targetVelOrth;double targetSpeedlTang=targetVelTang.Length();if(targetSpeedlTang>=interceptSpeed){return null;}double missileSpeedTang=targetSpeedlTang;double missileSpeedOrth=Math.Sqrt(interceptSpeed*interceptSpeed-missileSpeedTang*missileSpeedTang);if(targetSpeedlOrth>=missileSpeedOrth){return null;}double timeS=Vector3D.Distance(ownPosition,targetPosition)/(missileSpeedOrth-targetSpeedlOrth);Vector3D point=targetPosition+targetVelocity*timeS;return new InterceptResult{Position=point,TimeMs=timeS*1000};}}public class DirectionController2{public const double MIN_SPEED=50;public const float DEFAULT_FACTOR=2;readonly IMyShipController remoteControl;readonly IEnumerable<IMyGyro>gyroList;readonly float factor;public DirectionController2(IMyShipController remoteControl,IEnumerable<IMyGyro>gyroList,float factor=DEFAULT_FACTOR){this.remoteControl=remoteControl;this.gyroList=gyroList;this.factor=factor;}public void ICBM(MyDetectedEntityInfo target){var grav=remoteControl.GetNaturalGravity();var ownPos=remoteControl.GetPosition();var velocity=remoteControl.GetShipVelocities().LinearVelocity;var ownSpeed=Math.Max(velocity.Length(),MIN_SPEED);var point=Helpers.CalculateInterceptPoint(ownPos,ownSpeed,target.Position,target.Velocity);var targetPos=point==null?target.Position:point.Position;var targetVector=targetPos-ownPos;if(grav.IsZero()||targetVector.Length()<3500){Aim(targetPos);}else{Vector3D direction=CompensateSideVelocity(grav,targetVector);var axis=GetAxis(remoteControl.WorldMatrix.Forward,direction);SetGyroByAxis(axis,gyroList,factor);}}public void KeepHorizon(Vector3D?grav=null){var direction=grav??remoteControl.GetNaturalGravity();if(!direction.IsZero()){var axis=GetAxis(remoteControl.WorldMatrix.Down,direction);SetGyroByAxis(axis,gyroList,factor);}}public void Aim(Vector3D targetPos){var ownPos=remoteControl.GetPosition();var velocity=remoteControl.GetShipVelocities().LinearVelocity;var targetVector=CompensateSideVelocity(velocity,targetPos-ownPos);var axis=GetAxis(remoteControl.WorldMatrix.Forward,targetVector);SetGyroByAxis(axis,gyroList,factor);}public bool Intercept(Vector3D targetPosition,Vector3 targetVelocity){var ownPos=remoteControl.GetPosition();var velocity=remoteControl.GetShipVelocities().LinearVelocity;var ownSpeed=Math.Max(velocity.Length(),MIN_SPEED);var interceptPoint=Helpers.CalculateInterceptPoint(ownPos,ownSpeed,targetPosition,targetVelocity);var aimingPointPosition=interceptPoint?.Position??targetPosition;var direction=aimingPointPosition-ownPos;var compensatedTargetVector=CompensateSideVelocity(velocity,direction);var axis=GetAxis(remoteControl.WorldMatrix.Forward,compensatedTargetVector);SetGyroByAxis(axis,gyroList,factor);return interceptPoint!=null;}public bool InterceptShot(MyDetectedEntityInfo target,double bulletSpeed){var ownPos=remoteControl.GetPosition();var ownVelocity=remoteControl.GetShipVelocities().LinearVelocity;var relativeTargetVelocity=target.Velocity-ownVelocity;var point=Helpers.CalculateInterceptPoint(ownPos,bulletSpeed,target.Position,relativeTargetVelocity);var targetVector=point==null?(target.Position-ownPos):(point.Position-ownPos);var axis=GetAxis(remoteControl.WorldMatrix.Forward,targetVector);SetGyroByAxis(axis,gyroList,factor);return point!=null;}public static Vector3D CompensateSideVelocity(Vector3D velocity,Vector3D targetVector,float ratio=1){var sideVelocity=Vector3D.Reject(velocity,Vector3D.Normalize(targetVector));var sameDirection=Vector3D.Dot(velocity,targetVector)>0;return sameDirection?velocity-(1+ratio)*sideVelocity:(1-ratio)*sideVelocity-velocity;}public static Vector3D GetAxis(Vector3D currentDirection,Vector3D targetDirection){var target=Vector3D.Normalize(targetDirection);var current=Vector3D.Normalize(currentDirection);var axis=target.Cross(current);if(target.Dot(current)<0){axis=Vector3D.Normalize(axis);}return axis;}public static void SetGyroByAxis(Vector3D axis,IEnumerable<IMyGyro>gyroList,float factor=DEFAULT_FACTOR){foreach(var gyro in gyroList){gyro.Yaw=factor*Convert.ToSingle(axis.Dot(gyro.WorldMatrix.Up));gyro.Pitch=factor*Convert.ToSingle(axis.Dot(gyro.WorldMatrix.Right));gyro.Roll=factor*Convert.ToSingle(axis.Dot(gyro.WorldMatrix.Backward));}}}public class ShipDirectionController{public const int AIMBOT_RAILGUN_SPEED=2000;public const int AIMBOT_ARTILLERY_SPEED=500;const float MAX_ANGULAR_VELOCITY=30.0f;private const double MIN_DISTANCE=600;private const double MAX_DISTANCE=1900;private const double ACCURACY_LIMIT=0.012;const float ROTATION_RATIO=10.0f;public class PID{private const double PROPORTIONAL_MODE_LIMIT=0.07;public double MaxLength{get;set;}public double Kp{get;set;}public double Ki{get;set;}public double Kd{get;set;}private Vector3D errorSum;private Vector3D lastError;private DateTime lastErrorTimestamp;private bool reset=true;public Vector3D?LastError{get{if(reset)return null;return lastError;}}public PID(double kp,double ki,double kd,double maxLength){Kp=kp;Ki=ki;Kd=kd;MaxLength=maxLength;}protected virtual Vector3D GetIntegral(Vector3D currentError,Vector3D errorSum,double dt){var result=errorSum+currentError*dt;var length=result.Length();return length<MaxLength?result:result/length*MaxLength;}public Vector3D Control(Vector3D axis,DateTime now){var Sp=Kp*axis;if(Sp.Length()>PROPORTIONAL_MODE_LIMIT){reset=true;return Sp;}if(reset){errorSum=Vector3D.Zero;lastError=Vector3D.Zero;lastErrorTimestamp=now;reset=false;}var dt=(now-lastErrorTimestamp).TotalSeconds;Vector3D errorDerivative=(axis-lastError)/dt;errorSum=GetIntegral(axis,errorSum,dt);lastError=axis;lastErrorTimestamp=now;return Sp+Ki*errorSum+Kd*errorDerivative;}public virtual void Reset(){reset=true;}}private readonly IMyShipController controller;private readonly IEnumerable<IMyGyro>gyroList;private readonly PID pid=new PID(1,1,0,MAX_ANGULAR_VELOCITY);private DateTime?readyTimestamp;public event Action OnReadyToShot;public ShipDirectionController(IMyShipController controller,IEnumerable<IMyGyro>gyroList){this.controller=controller;this.gyroList=gyroList;foreach(IMyGyro b in gyroList){b.GyroOverride=true;b.Yaw=0f;b.Pitch=0f;b.Roll=0f;}}public void Update(){MatrixD wm=controller.WorldMatrix;MyShipVelocities velocities=controller.GetShipVelocities();Vector3D worldAngularVelocity=velocities.AngularVelocity;Vector3D axis=worldAngularVelocity*100*worldAngularVelocity.LengthSquared();axis+=wm.Right*controller.RotationIndicator.X*ROTATION_RATIO;axis+=wm.Up*controller.RotationIndicator.Y*ROTATION_RATIO;axis+=wm.Backward*controller.RollIndicator*ROTATION_RATIO;SetGyroByAxis(axis);}public void Aim(TargetInfo targetInfo,ForwardWeapon weapon,DateTime now){MatrixD wm=controller.WorldMatrix;var target=targetInfo.Entity;double bulletSpeed=GetBulletSpeed(weapon);var ownPos=controller.CenterOfMass;var ownVelocity=controller.GetShipVelocities().LinearVelocity;var targetPos=targetInfo.GetHitPosWorld();var relativeTargetVelocity=target.Velocity-ownVelocity;var point=Helpers.CalculateInterceptPoint(ownPos,bulletSpeed,targetPos,relativeTargetVelocity);var targetVector=point==null?(targetPos-ownPos):(point.Position-ownPos);var axis=DirectionController2.GetAxis(wm.Forward,targetVector);if(Math.Abs(controller.RollIndicator)>0.001){axis+=wm.Backward*controller.RollIndicator*ROTATION_RATIO;pid.Reset();}else{axis=pid.Control(axis,now);}SetGyroByAxis(axis);var distance=targetVector.Length();if(distance>MIN_DISTANCE&&distance<MAX_DISTANCE&&pid.LastError.HasValue&&pid.LastError.Value.Length()<ACCURACY_LIMIT){if(readyTimestamp.HasValue){if((now-readyTimestamp.Value).TotalMilliseconds>500){OnReadyToShot?.Invoke();}}else{readyTimestamp=now;}}else{readyTimestamp=null;}}private void SetGyroByAxis(Vector3D axis){if(axis.Length()>MAX_ANGULAR_VELOCITY){axis=Vector3D.Normalize(axis)*MAX_ANGULAR_VELOCITY;}DirectionController2.SetGyroByAxis(axis,gyroList);}private double GetBulletSpeed(ForwardWeapon value){switch(value){case ForwardWeapon.Railgun:return AIMBOT_RAILGUN_SPEED;case ForwardWeapon.Artillery:return AIMBOT_ARTILLERY_SPEED;}throw new Exception();}}public class TargetInfo{const int HIT_POINT_DEPTH=5;public MyDetectedEntityInfo Entity{get;private set;}public DateTime Timestamp{get;private set;}public DateTime NextScan{get;private set;}public Vector3D HitPosRelative{get;private set;}public Vector3D GetHitPosWorld(){return Entity.Position+Vector3D.Transform(HitPosRelative,Entity.Orientation);}public TargetInfo(MyDetectedEntityInfo entity=default(MyDetectedEntityInfo),DateTime timestamp=default(DateTime),DateTime nextScan=default(DateTime),Vector3D hitPosRelative=default(Vector3D)){Entity=entity;Timestamp=timestamp;NextScan=nextScan;HitPosRelative=hitPosRelative;}public TargetInfo Update(MyDetectedEntityInfo entity,DateTime timestamp,DateTime nextScan){Entity=entity;Timestamp=timestamp;NextScan=nextScan;return this;}public void UpdateNextScan(DateTime nextScan){NextScan=nextScan;}public static TargetInfo CreateTargetInfo(MyDetectedEntityInfo entity,Vector3D camPos,DateTime timestamp,DateTime?nextScan=null){var relativeHitPos=default(Vector3D);if(entity.HitPosition.HasValue){var hitPos=entity.HitPosition.Value;var correctedHitPos=hitPos+Vector3D.Normalize(hitPos-camPos)*HIT_POINT_DEPTH;var invertedMatrix=MatrixD.Invert(entity.Orientation);relativeHitPos=Vector3D.Transform(correctedHitPos-entity.Position,invertedMatrix);}return new TargetInfo(entity,timestamp,nextScan??timestamp,relativeHitPos);}}public static class Serializer{const char DIV=';';public class StringReader{private readonly string[]lines;private int nextPos=0;public StringReader(string value){lines=value.Split('\n');}public string GetNextLine(){return nextPos>=lines.Length?"":lines[nextPos++];}}public static void SerializeVector3D(Vector3D v,StringBuilder sb){sb.AppendLine(v.ToString());}public static void SerializeDateTime(DateTime d,StringBuilder sb){sb.AppendLine(d.ToBinary().ToString());}public static void SerializeMatrixD(MatrixD m,StringBuilder sb){var a=new double[]{m.M11,m.M12,m.M13,m.M14,m.M21,m.M22,m.M23,m.M24,m.M31,m.M32,m.M33,m.M34,m.M41,m.M42,m.M43,m.M44,};sb.AppendLine(string.Join(DIV.ToString(),a));}public static void SerializeMyDetectedEntityInfo(MyDetectedEntityInfo entity,StringBuilder sb){sb.AppendLine(entity.EntityId.ToString());sb.AppendLine(entity.Type.ToString());sb.AppendLine(entity.HitPosition?.ToString()??string.Empty);SerializeMatrixD(entity.Orientation,sb);sb.AppendLine(new Vector3D(entity.Velocity).ToString());sb.AppendLine(entity.Relationship.ToString());sb.AppendLine(entity.BoundingBox.Min.ToString());sb.AppendLine(entity.BoundingBox.Max.ToString());sb.AppendLine(entity.TimeStamp.ToString());}public static void SerializeTargetInfo(TargetInfo t,StringBuilder sb){SerializeMyDetectedEntityInfo(t.Entity,sb);SerializeVector3D(t.HitPosRelative,sb);SerializeDateTime(t.Timestamp,sb);}public static void SerializeTargetInfoArray(TargetInfo[]a,StringBuilder sb){sb.AppendLine(a.Length.ToString());foreach(var t in a){SerializeTargetInfo(t,sb);}}public static bool TryParseMatrixD(StringReader reader,out MatrixD m){try{var a=reader.GetNextLine().Split(DIV).Select(s=>double.Parse(s)).ToArray();m=new MatrixD(a[0],a[1],a[2],a[3],a[4],a[5],a[6],a[7],a[8],a[9],a[10],a[11],a[12],a[13],a[14],a[15]);return true;}catch{m=MatrixD.Zero;return false;}}public static bool TryParseNullableVector3D(StringReader reader,out Vector3D?v){var str=reader.GetNextLine();if(string.IsNullOrEmpty(str)){v=null;return true;}Vector3D tmp;if(Vector3D.TryParse(str,out tmp)){v=tmp;return true;}v=null;return false;}public static bool TryParseBoundingBoxD(StringReader reader,out BoundingBoxD b){string strMin=reader.GetNextLine();string strMax=reader.GetNextLine();Vector3D min,max;if(Vector3D.TryParse(strMin,out min)&&Vector3D.TryParse(strMax,out max)){b=new BoundingBoxD(min,max);return true;}b=new BoundingBoxD();return false;}public static bool TryParseMyDetectedEntityInfo(StringReader reader,out MyDetectedEntityInfo entity){var success=true;long entityId;success&=long.TryParse(reader.GetNextLine(),out entityId);MyDetectedEntityType type;success&=MyDetectedEntityType.TryParse(reader.GetNextLine(),out type);Vector3D?hitPosition;success&=TryParseNullableVector3D(reader,out hitPosition);MatrixD orientation;success&=TryParseMatrixD(reader,out orientation);Vector3D velocity;success&=Vector3D.TryParse(reader.GetNextLine(),out velocity);MyRelationsBetweenPlayerAndBlock relationship;success&=MyRelationsBetweenPlayerAndBlock.TryParse(reader.GetNextLine(),out relationship);BoundingBoxD boundingBox;success&=TryParseBoundingBoxD(reader,out boundingBox);long timestamp;success&=long.TryParse(reader.GetNextLine(),out timestamp);entity=success?new MyDetectedEntityInfo(entityId,string.Empty,type,hitPosition,orientation,velocity,relationship,boundingBox,timestamp):new MyDetectedEntityInfo();return success;}public static bool TryParseVector3D(StringReader reader,out Vector3D v){return Vector3D.TryParse(reader.GetNextLine(),out v);}public static bool TryParseDateTime(StringReader reader,out DateTime d){long ts;if(long.TryParse(reader.GetNextLine(),out ts)){d=DateTime.FromBinary(ts);return true;}d=DateTime.MinValue;return false;}public static bool TryParseTargetInfo(StringReader reader,out TargetInfo targetInfo){targetInfo=new TargetInfo();MyDetectedEntityInfo entity;if(!TryParseMyDetectedEntityInfo(reader,out entity))return false;Vector3D hitPos;if(!TryParseVector3D(reader,out hitPos))return false;DateTime timestamp;if(!TryParseDateTime(reader,out timestamp))return false;targetInfo=new TargetInfo(entity,timestamp,timestamp,hitPos);return true;}public static bool TryParseTargetInfoArray(StringReader reader,out TargetInfo[]result){TargetInfo target;int length;if(!int.TryParse(reader.GetNextLine(),out length)){result=null;return false;}result=new TargetInfo[length];for(var i=0;i<length;i++){if(TryParseTargetInfo(reader,out target)){result[i]=target;}else{result=null;return false;}}return true;}}public class TargetTracker{public static readonly string[]names=new[]{"корова","пёс","кролик","конь","медвед","кот","болт","кабан","волк","бобр","жук","zombie","сом",};public static string GetName(long entityId){var name=names[entityId%names.Length];var index=entityId%89;return$"{name}-{index}";}const int SCAN_DELAY_MS=20;const double DISTANCE_SCAN_DEFAULT=7500;const int TARGET_RELEASE_TIMEOUT=2;const int AI_INTERCEPT_PATTERN_ID=3;static readonly HashSet<MyDetectedEntityType>targetTypes=new HashSet<MyDetectedEntityType>{MyDetectedEntityType.SmallGrid,MyDetectedEntityType.LargeGrid};readonly IMyCameraBlock[]cameras;readonly IMyOffensiveCombatBlock ai;readonly IMyFlightMovementBlock flight;private int camIndex=0;public TargetInfo Current;public Vector3D?CurrentAiTarget=>flight?.CurrentWaypoint==null?null as Vector3D?:new Vector3D(flight.CurrentWaypoint.Matrix.GetRow(3));public event Action TargetLocked;public event Action TargetReleased;public int Count{get{return cameras.Length;}}public double TotalRange{get{return cameras.Aggregate(0d,(a,c)=>a+c.AvailableScanRange);}}public TargetTracker(IMyCameraBlock[]cameras,IMyOffensiveCombatBlock ai=null,IMyFlightMovementBlock flight=null){this.cameras=cameras;foreach(var cam in this.cameras){cam.Enabled=true;cam.EnableRaycast=true;}this.ai=ai;this.flight=flight;if(ai!=null&&flight!=null){ai.Enabled=true;ai.UpdateTargetInterval=5;ai.TargetPriority=OffensiveCombatTargetPriority.Largest;ai.SelectedAttackPattern=AI_INTERCEPT_PATTERN_ID;flight.Enabled=true;flight.PrecisionMode=false;flight.AlignToPGravity=false;flight.CollisionAvoidance=false;flight.FlightMode=FlightMode.OneWay;flight.MinimalAltitude=0;flight.SpeedLimit=100;}}private static TargetInfo GetTargetInfo(DateTime now,IMyCameraBlock cam,MyDetectedEntityInfo entity){if(entity.IsEmpty()){return null;}if(!targetTypes.Contains(entity.Type)){return null;}var camPos=cam.GetPosition();return TargetInfo.CreateTargetInfo(entity,camPos,now);}public static TargetInfo Scan(DateTime now,IMyCameraBlock cam,double distance=DISTANCE_SCAN_DEFAULT){if(cam==null){return null;}var entity=cam.Raycast(distance);return GetTargetInfo(now,cam,entity);}public bool TryLockPosition(DateTime now,Vector3D targetPos){var cam=cameras.FirstOrDefault(x=>x.CanScan(targetPos));if(cam==null){return false;}var entity=cam.Raycast(targetPos);var target=GetTargetInfo(now,cam,entity);if(target==null){return false;}LockTarget(target);return true;}public void LockTarget(TargetInfo target){if(target!=null){Current=target;TargetLocked?.Invoke();}}public void Clear(){if(Current!=null){Current=null;TargetReleased?.Invoke();}}public void Update(DateTime now){if(Current==null){return;}var prevTarget=Current;if(now<prevTarget.NextScan){return;}var timePassed=now-prevTarget.Timestamp;var entity=ScanNextPosition(prevTarget,timePassed);if(entity.IsEmpty()){if(timePassed.TotalSeconds>TARGET_RELEASE_TIMEOUT){Clear();}}else{Current.Update(entity,now,now.AddMilliseconds(SCAN_DELAY_MS));}}private static Vector3D CalculateTargetLocation(TargetInfo info,TimeSpan timePassed){var target=info.Entity;return info.GetHitPosWorld()+(target.Velocity*Convert.ToSingle(timePassed.TotalSeconds));}private MyDetectedEntityInfo ScanNextPosition(TargetInfo prevTarget,TimeSpan timePassed){var calculatedTargetPos=CalculateTargetLocation(prevTarget,timePassed);var camera=GetNext(cameras,ref camIndex,cam=>cam.CanScan(calculatedTargetPos));if(camera==null){return default(MyDetectedEntityInfo);}var entity=camera.Raycast(calculatedTargetPos);if(entity.EntityId!=prevTarget.Entity.EntityId){return default(MyDetectedEntityInfo);}return entity;}public static T GetNext<T>(T[]a,ref int index,Func<T,bool>filter=null){if(a.Length==0){return default(T);}for(var count=0;count<a.Length;count++){index=(index+1)%a.Length;T block=a[index];if(filter==null||filter(block)){return block;}}return default(T);}}public enum FiringMode{Auto,Forward}public enum ForwardWeapon{Artillery,Railgun,}public class WeaponState{public int TorpedosCount{get;set;}public int RalgunsCount{get;set;}public float RalgunsСharge{get;set;}public int RalgunsReadyCount{get;set;}public int TurretsCount{get;set;}public FiringMode TurretsFiringMode{get;set;}}public class HudState{public Vector3D?AiTarget{get;set;}public TargetInfo Target{get;set;}public ForwardWeapon?Aimbot{get;set;}public WeaponState Weapon{get;set;}public bool EnemyLock{get;set;}}public class HUD{const int BEACON_RADIUS=70;private static readonly HashSet<MyRelationsBetweenPlayerAndBlock>friends=new HashSet<MyRelationsBetweenPlayerAndBlock>{MyRelationsBetweenPlayerAndBlock.Owner,MyRelationsBetweenPlayerAndBlock.FactionShare,MyRelationsBetweenPlayerAndBlock.Friends,MyRelationsBetweenPlayerAndBlock.Neutral,};private readonly IMyTextPanel[]displays;private readonly IMyBeacon beacon;private readonly Func<DateTime,HudState>getState;private DateTime lastUpdateHUD;public HUD(IMyTextPanel[]displays,IMyBeacon beacon,Func<DateTime,HudState>getState){this.getState=getState;this.beacon=beacon;this.beacon.Enabled=true;this.beacon.Radius=BEACON_RADIUS;this.displays=displays;foreach(var d in displays){d.Enabled=true;d.ContentType=ContentType.SCRIPT;d.BackgroundColor=Color.Black;d.BackgroundAlpha=0;}}private static string Cut(string text,int length=23){return text.Length>length?text.Substring(0,length-1)+"…":text;}public void Update(DateTime now,Vector3D selfPos){lastUpdateHUD=now;var state=getState(now);var w=state.Weapon;string targetName=null;string dist=null;if(state.Target!=null){var t=state.Target.Entity;var d=(t.Position-selfPos).Length();var size=t.Type==MyDetectedEntityType.SmallGrid?"SM":"LG";var name=TargetTracker.GetName(t.EntityId);targetName=friends.Contains(t.Relationship)?$"{size} ∙ {Cut(t.Name)}":$"{size} ∙ {name}";dist=d.ToString("0m");}var tm=w.TurretsFiringMode==FiringMode.Forward?"Fwd":"Auto";var turrets=w.TurretsCount>0?$"{w.TurretsCount} ∙ {tm}":tm;var aimbot=GetAimbotText(state.Aimbot);var ai="empty";if(state.AiTarget.HasValue){var aiDist=(state.AiTarget.Value-selfPos).Length();ai=$"{aiDist:0}m";}var sprites=GetSprites(ai,targetName,dist,aimbot,turrets,w.TorpedosCount,state.EnemyLock,w.RalgunsCount,w.RalgunsReadyCount,w.RalgunsСharge);foreach(var lcd in displays){using(var frame=lcd.DrawFrame()){frame.AddRange(sprites);if(state.AiTarget.HasValue){lcd.ContentType=ContentType.TEXT_AND_IMAGE;frame.AddRange(GetTargetSprite(lcd,state.AiTarget.Value));lcd.ContentType=ContentType.SCRIPT;}}}var ti=targetName==null?"NO TARGET":$"{targetName} ∙ {dist}";var p=w.RalgunsСharge*100;var rp=p>0?$" ∙ {p:0}%":"";beacon.HudText=$"{ti} | AI: {ai}\n{aimbot} | {tm} | Rail: {w.RalgunsReadyCount}{rp}";}private string GetAimbotText(ForwardWeapon?aimbot){switch(aimbot){case ForwardWeapon.Railgun:return"Rail";case ForwardWeapon.Artillery:return"Art";default:return"Off";}}const float CAM_DISTANCE=3.75f;const float LCD_HALF_WIDTH=1.1f;private MySprite[]GetTargetSprite(IMyTextPanel screen,Vector3D targetPos){var c=Color.Orange;var m=screen.WorldMatrix;var screenPos=screen.GetPosition();var camPos=screenPos+m.Backward*CAM_DISTANCE;var targetVector=targetPos-camPos;var rate=CAM_DISTANCE/targetVector.Length();var v=targetVector.Dot(m.Down)*rate;var h=targetVector.Dot(m.Right)*rate;var d=targetVector.Dot(m.Forward);var maxPos=Math.Max(Math.Abs(h),Math.Abs(v));if(d>0&&maxPos<LCD_HALF_WIDTH){var x=Convert.ToInt32(256*(1+h/LCD_HALF_WIDTH));var y=Convert.ToInt32(256*(1+v/LCD_HALF_WIDTH));return new MySprite[]{new MySprite{Type=SpriteType.TEXTURE,Data="SquareHollow",Position=new Vector2(x-16,y),Size=new Vector2(32,32),Color=c}};}else{var x=Convert.ToInt32(256*(1+h/maxPos));var y=Convert.ToInt32(256*(1+v/maxPos));var data=d<0?"Triangle":"SquareSimple";return new MySprite[]{new MySprite{Type=SpriteType.TEXTURE,Data=data,Position=new Vector2(x>256?x-12:x,y>256?y-12:y),Size=new Vector2(12,12),Color=c}};}}private MySprite[]GetSprites(string aiTarget,string targetName,string dist,string aimbot,string turrets,int tCount,bool enemyLock,int rgTotal,int rgReady,float rgChargeLevel){var list=new List<MySprite>();list.AddRange(Text("target",targetName??"NO TARGET",TextAlignment.CENTER,TOP));if(dist!=null){list.AddRange(Text("dist",dist,TextAlignment.LEFT,TOP));}list.AddRange(Text("ai target",aiTarget,TextAlignment.RIGHT,TOP));list.AddRange(Text("torpedos",tCount.ToString(),TextAlignment.RIGHT,TOP+1));list.AddRange(Text("aimbot",aimbot,TextAlignment.CENTER,BOTTOM));list.AddRange(Text("turrets",turrets,TextAlignment.LEFT,BOTTOM));if(enemyLock){list.AddRange(Text(null,"ENEMY LOCK",TextAlignment.CENTER,BOTTOM-1,color:Color.OrangeRed));}if(rgTotal>0){list.AddRange(Text("railgun",$"{rgReady} / {rgTotal}",TextAlignment.RIGHT,BOTTOM));list.Add(new MySprite(){Type=SpriteType.TEXTURE,Data="SquareSimple",Position=new Vector2(452,509),Size=new Vector2(Convert.ToInt32(60*rgChargeLevel),3),Color=Color.Teal,});}return list.ToArray();}const int TOP=0;const int BOTTOM=9;const int LABEL_HEIGHT=20;const int VALUE_HEIGHT=30;const int LINE_HEIGHT=51;const int CELL_WIDTH=128;private MySprite[]Text(string label,string text,TextAlignment alignment,byte line=TOP,byte offset=0,Color?color=null){int x=0;switch(alignment){case TextAlignment.LEFT:x=0+offset*CELL_WIDTH;break;case TextAlignment.RIGHT:x=512-offset*CELL_WIDTH;break;case TextAlignment.CENTER:x=256;break;}int y=line*LINE_HEIGHT;var valueSprite=new MySprite(){Type=SpriteType.TEXT,Data=text,Position=new Vector2(x,y+LABEL_HEIGHT),RotationOrScale=1f,Color=color??Color.White,Alignment=alignment,FontId="White"};if(string.IsNullOrEmpty(label)){return new[]{valueSprite};}return new[]{new MySprite{Type=SpriteType.TEXT,Data=label,Position=new Vector2(x,y),RotationOrScale=0.8f,Color=Color.Teal,Alignment=alignment,FontId="White"},valueSprite};}}public enum LaunchStage{Ready,Started,Dead,Invalid}public struct TorpedoStatus{public LaunchStage Stage;public string Name;public double Distance;public override string ToString(){return Stage==LaunchStage.Started?$"{Name}: {Stage} => {Distance:0}m":$"{Name}: {Stage}";}}public abstract class BaseTorpedo{protected readonly int delay;protected readonly int lifespan;protected readonly string name;protected readonly DirectionController2 tControl;protected readonly IMyRemoteControl tRemote;protected readonly IMyShipMergeBlock tClamp;protected readonly List<IMyGyro>listGyro=new List<IMyGyro>();protected readonly List<IMyThrust>listEngine=new List<IMyThrust>();protected readonly List<IMyGasGenerator>listH2Gen=new List<IMyGasGenerator>();protected DateTime startTime=DateTime.MaxValue;protected DateTime deathTime=DateTime.MaxValue;protected bool started=false;public long EntityId=>(tRemote?.EntityId).GetValueOrDefault();public string Name=>name;public Vector3D Position=>tRemote.GetPosition();public double GetSpeed(DateTime now)=>started&&IsAlive(now)?tRemote.GetShipSpeed():0;public bool IsInvalid=>!listEngine.Any()||!listGyro.Any()||tRemote==null||tClamp==null;public LaunchStage GetStage(DateTime now)=>!IsAlive(now)?LaunchStage.Dead:started?LaunchStage.Started:IsInvalid?LaunchStage.Invalid:LaunchStage.Ready;public bool IsAlive(DateTime now)=>tRemote.IsFunctional&&listEngine.All(e=>e.IsFunctional&&e.CubeGrid.EntityId==tRemote.CubeGrid.EntityId)&&listGyro.All(g=>g.IsFunctional&&g.CubeGrid.EntityId==tRemote.CubeGrid.EntityId)&&now<deathTime;protected BaseTorpedo(IMyBlockGroup group,int delay=2000,float factor=7,int lifespan=360){name=group.Name;this.delay=delay;this.lifespan=lifespan;group.GetBlocksOfType(listGyro);group.GetBlocksOfType(listEngine);group.GetBlocksOfType(listH2Gen);var tmp=new List<IMyTerminalBlock>();group.GetBlocks(tmp);tClamp=tmp.FirstOrDefault(b=>b is IMyShipMergeBlock)as IMyShipMergeBlock;tRemote=tmp.FirstOrDefault(b=>b is IMyRemoteControl)as IMyRemoteControl;tControl=new DirectionController2(tRemote,listGyro,factor);}public virtual void Start(DateTime now){startTime=now;deathTime=startTime.AddSeconds(lifespan);tClamp.Enabled=false;listGyro.ForEach(g=>{g.Enabled=true;g.GyroOverride=true;});listH2Gen.ForEach(g=>{g.Enabled=true;});listEngine.ForEach(e=>{e.Enabled=true;e.ThrustOverridePercentage=1;});started=true;}public virtual TorpedoStatus Update(DateTime now,TargetInfo target){double distance=0;if((now-startTime).TotalMilliseconds>delay){if(target!=null){distance=(target.Entity.Position-Position).Length();SetDirection(target,distance);}}return new TorpedoStatus{Name=name,Stage=GetStage(now),Distance=distance,};}protected abstract void SetDirection(TargetInfo targetInfo,double distance);}public class SpaceTorpedo:BaseTorpedo{const double INTERCEPT_DISTANCE=800;public SpaceTorpedo(IMyBlockGroup group,int delay=2000,float factor=7,int lifespan=480):base(group,delay,factor,lifespan){}protected override void SetDirection(TargetInfo targetInfo,double distance){var targetPos=targetInfo.GetHitPosWorld();if(distance<INTERCEPT_DISTANCE){tControl.Intercept(targetPos,targetInfo.Entity.Velocity);}else{tControl.Aim(targetPos);}}}public class WeaponController{const int RAYCAST_DISTANCE=6500;const int TORPEDO_LIFESPAN=600;const int BEACON_RADIUS=70;private LocalTime localTime;private TargetTracker tracker;private IMyTextSurface lcdTorpedos;private IMyTextSurface lcdSystem;private IMySoundBlock sound;private IMySoundBlock soundEnemyLock;private IMySmallMissileLauncherReload[]railguns;private IMySmallMissileLauncher[]artillery;private IMyLargeMissileTurret[]turrets;public bool EnemyLock{get;private set;}public FiringMode FiringMode{get;private set;}public ForwardWeapon?Aimbot{get;private set;}public TargetInfo CurrentTarget=>tracker.Current;public Vector3D?CurrentAiTarget=>tracker.CurrentAiTarget;public WeaponState GetState(DateTime now){var railguns=this.railguns.Where(r=>r.IsWorking).ToArray();int rgReadyCount=0;float rgPercent=0;for(int i=0;i<railguns.Length;i++){var value=GetRailgunChargeLevel(railguns[i]);if(value>0.99){rgReadyCount++;}if(value<0.99&&value>rgPercent){rgPercent=value;}}var torpedosCount=torpedos.Values.Count(t=>t.GetStage(now)==LaunchStage.Ready);var turretsCount=turrets.Count(t=>t.IsWorking);return new WeaponState{RalgunsСharge=rgPercent,RalgunsCount=railguns.Length,RalgunsReadyCount=rgReadyCount,TorpedosCount=torpedosCount,TurretsCount=turretsCount,TurretsFiringMode=FiringMode,};}public event Action<Exception>OnError;readonly Dictionary<long,SpaceTorpedo>torpedos=new Dictionary<long,SpaceTorpedo>();public WeaponController(LocalTime localTime,IMyCameraBlock[]cameras,IMyLargeMissileTurret[]turrets,IMySmallMissileLauncherReload[]railguns,IMySmallMissileLauncher[]artillery,IMyTextSurface lcdTorpedos,IMyTextSurface lcdSystem,IMySoundBlock sound,IMySoundBlock soundEnemyLock,IMyOffensiveCombatBlock ai,IMyFlightMovementBlock flight){this.localTime=localTime;tracker=new TargetTracker(cameras,ai,flight);tracker.TargetLocked+=Tracker_TargetChanged;tracker.TargetReleased+=Tracker_TargetChanged;this.lcdTorpedos=lcdTorpedos;this.lcdSystem=lcdSystem;this.railguns=railguns;this.artillery=artillery;this.turrets=turrets;this.sound=sound;this.soundEnemyLock=soundEnemyLock;}public void Scan(IMyCameraBlock cam){var now=localTime.Now;var target=TargetTracker.Scan(now,cam,RAYCAST_DISTANCE);if(target!=null){tracker.LockTarget(target);}}public void Scan(Vector3D?targetPos){if(targetPos.HasValue){tracker.TryLockPosition(localTime.Now,targetPos.Value);}}public void Reload(IMyBlockGroup[]groups){var now=localTime.Now;foreach(var gr in groups){var tmp=new SpaceTorpedo(gr,factor:2f,lifespan:TORPEDO_LIFESPAN);if(!torpedos.ContainsKey(tmp.EntityId)){torpedos.Add(tmp.EntityId,tmp);}}foreach(var t in torpedos.ToArray()){if(!t.Value.IsAlive(now)){torpedos.Remove(t.Key);}}}public void ToggleAimbot(){switch(Aimbot){case null:Aimbot=ForwardWeapon.Artillery;break;case ForwardWeapon.Artillery:Aimbot=ForwardWeapon.Railgun;break;default:Aimbot=null;break;}}public void SetEnemyLock(){EnemyLock=true;soundEnemyLock?.Play();}public void ClearEnemyLock(){EnemyLock=false;soundEnemyLock?.Stop();}public void ToggleFiringMode(){FiringMode=FiringMode==FiringMode.Forward?FiringMode.Auto:FiringMode.Forward;foreach(var t in turrets){if(FiringMode==FiringMode.Forward){t.Range=0;t.EnableIdleRotation=false;t.SyncEnableIdleRotation();}else{t.Range=1000;t.EnableIdleRotation=true;t.SyncEnableIdleRotation();}}}public bool Launch(){var now=localTime.Now;var torpedo=torpedos.Values.FirstOrDefault(t=>t.GetStage(now)==LaunchStage.Ready);if(torpedo==null){return false;}torpedo.Start(now);return true;}private bool Exec(Action action){try{action();}catch(Exception e){OnError(e);}return true;}private IEnumerator<bool>GetEventLoop(){while(true){yield return Exec(()=>tracker.Update(localTime.Now));yield return Exec(()=>UpdateTorpedoTargets(localTime.Now));yield return Exec(()=>UpdateLcdSystem());}}private IEnumerator<bool>actions=null;public void UpdateNext(){var a=actions??(actions=GetEventLoop());if(!a.MoveNext()){a.Dispose();actions=null;}}public void TryFire(){if(Aimbot==ForwardWeapon.Artillery&&FiringMode==FiringMode.Forward){foreach(var t in turrets){t.Range=0;t.SetManualAzimuthAndElevation(0,0);t.SyncAzimuth();t.SyncElevation();}}IMyUserControllableGun[]list=null;IMyLargeMissileTurret[]listTurrets=null;switch(Aimbot){case ForwardWeapon.Railgun:list=railguns.Where(r=>r.IsWorking).ToArray();break;case ForwardWeapon.Artillery:list=artillery.Where(r=>r.IsWorking).ToArray();if(FiringMode==FiringMode.Forward){listTurrets=turrets.Where(r=>r.IsWorking&&r.Azimuth<0.001&&r.Elevation<0.001).ToArray();}break;}if(list!=null&&list.Any()){foreach(var r in list){r.ShootOnce();}}if(listTurrets!=null&&listTurrets.Any()){foreach(var r in listTurrets){r.ShootOnce();}}}private void UpdateTorpedoTargets(DateTime now){var sb=new StringBuilder();var target=tracker.Current;foreach(var t in torpedos.Values){var state=t.Update(now,target);sb.AppendLine(state.ToString());}lcdTorpedos?.WriteText(sb);}private void UpdateLcdSystem(){var sb=new StringBuilder();sb.AppendLine($"Total range: {tracker.TotalRange:0.0}");sb.AppendLine($"Cam count: {tracker.Count}");lcdSystem?.WriteText(sb);}private void Tracker_TargetChanged(){sound?.Play();}private float GetRailgunChargeLevel(IMySmallMissileLauncherReload railgun,float max=500){if(railgun.BlockDefinition.SubtypeId!="LargeRailgun"){return 0f;}var lines=railgun.DetailedInfo.Split('\n');var chargeInfo=lines[1];var start=0;while(!char.IsDigit(chargeInfo[start])){start++;}var end=start+1;while(char.IsDigit(chargeInfo[end])||chargeInfo[end]=='.'){end++;}var strValue=chargeInfo.Substring(start,end-start);var current=Convert.ToSingle(strValue);float result=current/max;return result;}}private const string GROUP_PREFIX_TORPEDO="ws_torpedo";readonly Grid grid;readonly LocalTime localTime;readonly GravityDrive gdrive;readonly ShipDirectionController directionController;readonly WeaponController weapons;readonly HUD hud;readonly IMyCameraBlock cameraTop;readonly IMyCameraBlock cameraBottom;readonly IMyShipWelder[]welders;readonly IMyCockpit cockpit;private const int TICK_COUNT=12;private const double AVG_RUNTIME_LIMIT=0.24;private int tick=0;private bool sameGrid<T>(T b)where T:IMyTerminalBlock{return b.CubeGrid==Me.CubeGrid;}public Program(){grid=new Grid(GridTerminalSystem);localTime=new LocalTime(Runtime);welders=grid.GetBlocksOfType<IMyShipWelder>(sameGrid);cockpit=grid.GetBlockWithName<IMyCockpit>("ws_cockpit");cameraTop=grid.GetCamera("ws_cam_t");cameraBottom=grid.GetCamera("ws_cam_b");var cameras=grid.GetBlocksOfType<IMyCameraBlock>(cam=>!cam.CustomName.StartsWith("ws_cam"));var beacon=grid.GetBlockWithName<IMyBeacon>("ws_beacon");var railguns=grid.GetLargeRailguns(sameGrid);var artillery=grid.GetArtillery(sameGrid);var turrets=grid.GetArtilleryTurrets(sameGrid);var lcdHUD=grid.GetBlocksOfType<IMyTextPanel>(p=>p.CustomName.StartsWith("ws_hud"));var lcdSystem=cockpit.GetSurface(1);var lcdTorpedos=cockpit.GetSurface(2);var sound=grid.GetSound("ws_sound_1","SoundBlockEnemyDetected");var soundEnemyLock=grid.GetSound("ws_sound_2","SoundBlockAlert1");var ajs=grid.GetBlockWithName<IMyMotorStator>("ws_ajs");var ai=grid.GetByFilterOrAny<IMyOffensiveCombatBlock>(b=>b.CubeGrid==ajs.TopGrid);var flight=grid.GetByFilterOrAny<IMyFlightMovementBlock>(b=>b.CubeGrid==ajs.TopGrid);var group=GridTerminalSystem.GetBlockGroupWithName("ws_gdrive");var gyros=new List<IMyGyro>();group.GetBlocksOfType(gyros);hud=new HUD(lcdHUD,beacon,GetHudState);gdrive=new GravityDrive(cockpit,group);directionController=new ShipDirectionController(cockpit,gyros);directionController.OnReadyToShot+=OnReadyToShot;weapons=new WeaponController(localTime,cameras,turrets,railguns,artillery,lcdTorpedos,lcdSystem,sound,soundEnemyLock,ai,flight);weapons.OnError+=HandleError;Runtime.UpdateFrequency=UpdateFrequency.Update1;}private void OnReadyToShot(){weapons.TryFire();}private HudState GetHudState(DateTime now){return new HudState{AiTarget=weapons.CurrentAiTarget,Aimbot=weapons.Aimbot,EnemyLock=weapons.EnemyLock,Target=weapons.CurrentTarget,Weapon=weapons.GetState(now),};}private void HandleError(Exception ex){Echo(ex.ToString());}public void Main(string argument,UpdateType updateSource){var now=localTime.Update(updateSource);if((updateSource&UpdateType.Update1)==UpdateType.Update1){if(localTime.Avg<AVG_RUNTIME_LIMIT){tick=(tick+1)%TICK_COUNT;switch(tick){case 2:case 4:case 8:weapons.UpdateNext();break;case 1:case 7:gdrive.Update();break;case 5:case 11:hud.Update(now,cockpit.GetPosition());break;case 0:case 3:case 6:case 9:if(weapons.Aimbot.HasValue&&weapons.CurrentTarget!=null){directionController.Aim(weapons.CurrentTarget,weapons.Aimbot.Value,now);}else{directionController.Update();}break;}}}else{switch(argument){case"aimbot":weapons.ToggleAimbot();break;case"mode":weapons.ToggleFiringMode();break;case"lock-ai":weapons.Scan(weapons.CurrentAiTarget);break;case"lock-top":weapons.Scan(cameraTop);break;case"lock-bottom":weapons.Scan(cameraBottom);break;case"reload":var groups=grid.GetBlockGroups(GROUP_PREFIX_TORPEDO);weapons.Reload(groups);break;case"start":weapons.Launch();break;case"set-enemy-lock":weapons.SetEnemyLock();break;case"clear-enemy-lock":weapons.ClearEnemyLock();break;}}}private string Format(double p,double v,string textP,string textN){double r=v-p;string label=r>0?textP:textN;return$"{label}: {r:0.0}";}private string FormatGPS(Vector3D point,string label){return$"GPS:{label}:{point.X:0.00}:{point.Y:0.00}:{point.Z:0.00}:#FF89F175:";}private void UpdateGdInfo(){var x=gdrive.CalculateCenterOfMass();var p=x.Physical.Local;var v=x.Virtual.Local;var sb=new StringBuilder();sb.AppendLine(Format(p.Z,v.Z,"Fwd","Bck"));sb.AppendLine(Format(p.X,v.X,"Rgt","Lft"));sb.AppendLine(Format(p.Z,v.Z,"Top","Btm"));Me.GetSurface(0).WriteText(sb);Me.CustomData=FormatGPS(x.Physical.World,"GD Center")+"\n"+FormatGPS(x.Virtual.World,"GD Virtual center");}
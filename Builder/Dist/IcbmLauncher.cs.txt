//10/19/2023 10:37:12 AM
public static class Helpers{public class InterceptResult{public Vector3D Position;public double TimeMs;}public static InterceptResult CalculateInterceptPoint(Vector3D ownPosition,double interceptSpeed,Vector3D targetPosition,Vector3D targetVelocity){Vector3D directionToTarget=Vector3D.Normalize(targetPosition-ownPosition);double targetSpeedlOrth=Vector3D.Dot(targetVelocity,directionToTarget);Vector3D targetVelOrth=directionToTarget*targetSpeedlOrth;Vector3D targetVelTang=targetVelocity-targetVelOrth;double targetSpeedlTang=targetVelTang.Length();if(targetSpeedlTang>=interceptSpeed){return null;}double missileSpeedTang=targetSpeedlTang;double missileSpeedOrth=Math.Sqrt(interceptSpeed*interceptSpeed-missileSpeedTang*missileSpeedTang);if(targetSpeedlOrth>=missileSpeedOrth){return null;}double timeS=Vector3D.Distance(ownPosition,targetPosition)/(missileSpeedOrth-targetSpeedlOrth);Vector3D point=targetPosition+targetVelocity*timeS;return new InterceptResult{Position=point,TimeMs=timeS*1000};}}public class DirectionController2{public const double MIN_SPEED=50;readonly IMyShipController remoteControl;readonly IEnumerable<IMyGyro>gyroList;readonly float factor;public DirectionController2(IMyShipController remoteControl,IEnumerable<IMyGyro>gyroList,float factor){this.remoteControl=remoteControl;this.gyroList=gyroList;this.factor=factor;}public void ICBM(Vector3D targetPos){var grav=remoteControl.GetNaturalGravity();if(!grav.IsZero()){var ownPos=remoteControl.GetPosition();var targetVector=targetPos-ownPos;Vector3D direction;if(targetVector.Length()>3500){direction=CompensateSideVelocity(grav,targetVector);}else{var velocity=remoteControl.GetShipVelocities().LinearVelocity;direction=CompensateSideVelocity(velocity,targetVector,1.5f);}var axis=GetAxis(remoteControl.WorldMatrix.Forward,direction);SetGyroByAxis(axis);}}public void KeepHorizon(){var grav=remoteControl.GetNaturalGravity();if(!grav.IsZero()){var axis=GetAxis(remoteControl.WorldMatrix.Down,grav);SetGyroByAxis(axis);}}public void Aim(Vector3D targetPos){var ownPos=remoteControl.GetPosition();var velocity=remoteControl.GetShipVelocities().LinearVelocity;var targetVector=CompensateSideVelocity(velocity,targetPos-ownPos);var axis=GetAxis(remoteControl.WorldMatrix.Forward,targetVector);SetGyroByAxis(axis);}public void Intercept(MyDetectedEntityInfo target){var ownPos=remoteControl.GetPosition();var velocity=remoteControl.GetShipVelocities().LinearVelocity;var ownSpeed=Math.Max(velocity.Length(),MIN_SPEED);var point=Helpers.CalculateInterceptPoint(ownPos,ownSpeed,target.Position,target.Velocity);var direction=point==null?new Vector3D(target.Velocity):(point.Position-ownPos);var targetVector=CompensateSideVelocity(velocity,direction);var axis=GetAxis(remoteControl.WorldMatrix.Forward,targetVector);SetGyroByAxis(axis);}public static Vector3D CompensateSideVelocity(Vector3D velocity,Vector3D targetVector,float ratio=1){var sideVelocity=Vector3D.Reject(velocity,Vector3D.Normalize(targetVector));var sameDirection=Vector3D.Dot(velocity,targetVector)>0;return sameDirection?velocity-(1+ratio)*sideVelocity:(1-ratio)*sideVelocity-velocity;}public static Vector3D GetAxis(Vector3D currentDirection,Vector3D targetDirection){var target=Vector3D.Normalize(targetDirection);var current=Vector3D.Normalize(currentDirection);var axis=target.Cross(current);if(target.Dot(current)<0){axis=Vector3D.Normalize(axis);}return axis;}public void SetGyroByAxis(Vector3D axis){foreach(var gyro in gyroList){gyro.Yaw=factor*Convert.ToSingle(axis.Dot(gyro.WorldMatrix.Up));gyro.Pitch=factor*Convert.ToSingle(axis.Dot(gyro.WorldMatrix.Right));gyro.Roll=factor*Convert.ToSingle(axis.Dot(gyro.WorldMatrix.Backward));}}}public enum MissileState{Ready,Started,Dead,Invalid}public class Icbm{public readonly string Id=DateTime.UtcNow.Ticks.ToString();readonly int delay;readonly string name;readonly DirectionController2 tControl;readonly List<IMyGyro>listGyro=new List<IMyGyro>();readonly List<IMyThrust>listEngine=new List<IMyThrust>();readonly List<IMyGasGenerator>listH2Gen=new List<IMyGasGenerator>();readonly IMyRemoteControl tRemote;readonly IMyShipMergeBlock tClamp;DateTime startTime=DateTime.MaxValue;MissileState State=>!IsAlive?MissileState.Dead:Started?MissileState.Started:IsReady?MissileState.Ready:MissileState.Invalid;public Vector3D Position=>tRemote.GetPosition();public double Speed=>Started&&IsAlive?tRemote.GetShipSpeed():0;public bool IsReady=>listEngine.Any()&&listGyro.Any()&&tRemote!=null&&tClamp!=null;public bool Started{get;private set;}public Vector3D TargetPos{get;private set;}public long EntityId=>(tRemote?.EntityId).GetValueOrDefault();public bool IsAlive=>tRemote.IsFunctional&&listEngine.All(e=>e.IsFunctional&&e.CubeGrid.EntityId==tRemote.CubeGrid.EntityId)&&listGyro.All(g=>g.IsFunctional&&g.CubeGrid.EntityId==tRemote.CubeGrid.EntityId);public Icbm(IMyBlockGroup group,int delay=1000,float factor=4){name=group.Name;this.delay=delay;group.GetBlocksOfType(listGyro);group.GetBlocksOfType(listEngine);group.GetBlocksOfType(listH2Gen);var tmp=new List<IMyTerminalBlock>();group.GetBlocks(tmp);tClamp=tmp.FirstOrDefault(b=>b is IMyShipMergeBlock)as IMyShipMergeBlock;tRemote=tmp.FirstOrDefault(b=>b is IMyRemoteControl)as IMyRemoteControl;tControl=new DirectionController2(tRemote,listGyro,factor);}public void Start(Vector3D targetPos){TargetPos=targetPos;startTime=DateTime.UtcNow;tClamp.Enabled=false;listGyro.ForEach(g=>{g.Enabled=true;g.GyroOverride=true;});listH2Gen.ForEach(g=>{g.Enabled=true;});listEngine.ForEach(e=>{e.Enabled=true;e.ThrustOverridePercentage=1;});Started=true;}public void Update(){if((DateTime.UtcNow-startTime).TotalMilliseconds>delay){tControl.ICBM(TargetPos);}}public override string ToString(){var dist=(TargetPos-Position).Length();return State==MissileState.Started?$"{name}: {State} => {dist}m":$"{name}: {State}";}}string BROAD_CAST_TAG="start_icbm";List<Icbm>missiles=new List<Icbm>();IMyBroadcastListener listener;IMyTextSurface LCD=>Me.GetSurface(0);public Program(){listener=IGC.RegisterBroadcastListener(BROAD_CAST_TAG);listener.SetMessageCallback();Runtime.UpdateFrequency=UpdateFrequency.Update1;}public void Main(string argument,UpdateType updateSource){if(updateSource==UpdateType.IGC){while(listener.HasPendingMessage){var message=listener.AcceptMessage();StartNextMissile(message.Data);}}else{switch(argument){case"init":var ids=new HashSet<long>(missiles.Select(t=>t.EntityId));var groups=new List<IMyBlockGroup>();GridTerminalSystem.GetBlockGroups(groups,g=>g.Name.StartsWith("ICBM"));missiles.AddRange(groups.Select(gr=>new Icbm(gr)).Where(t=>!ids.Contains(t.EntityId)));missiles.RemoveAll(m=>!m.IsAlive);break;case"start":StartNextMissile(Me.CustomData);break;}foreach(var m in missiles.Where(m=>m.IsAlive&&m.Started)){m.Update();}LCD.WriteText(string.Join("\n\n",missiles));}}private void StartNextMissile(object value){Vector3D target;if(Vector3D.TryParse(value.ToString(),out target)){var missile=missiles.FirstOrDefault(m=>m.IsReady&&!m.Started);if(missile!=null&&!target.IsZero()){missile.Start(target);}}}
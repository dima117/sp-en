//10/22/2023 8:41:16 PM
public class BlockArray<T>where T:class,IMyTerminalBlock{MyGridProgram program;Action<T>init;private List<T>list=new List<T>();private int index=0;public int Count=>list.Count;public BlockArray(MyGridProgram program,Action<T>init=null){this.program=program;this.init=init;UpdateBlocks();}public void UpdateBlocks(){list=new List<T>();index=0;var tmp=new List<IMyTerminalBlock>();program.GridTerminalSystem.GetBlocks(tmp);foreach(var x in tmp){var block=x as T;if(block!=null){list.Add(block);init(block);}}}public void ForEach(Action<T>fn=null){if(fn!=null){list.ForEach(fn);}}public T GetNext(Func<T,bool>filter=null){for(var count=0;count<list.Count;count++){index++;if(index>=list.Count){index=0;}T block=list[index];if(filter==null||filter(block)){return block;}}return null;}}public class Transmitter{public const string TAG_ICBM_STATE="TAG_ICBM_STATE";public const string TAG_TARGET_POSITION="TAG_TARGET_POSITION";public const string TAG_ICBM_CONNECT="TAG_ICBM_CONNECT";public const int MIN_RANGE=10;public const int MAX_RANGE=50000;private int seq=0;private BlockArray<IMyRadioAntenna>blocks;private IMyIntergridCommunicationSystem igc;private Dictionary<string,Action<MyIGCMessage>>actions=new Dictionary<string,Action<MyIGCMessage>>();private Dictionary<string,IMyBroadcastListener>listeners=new Dictionary<string,IMyBroadcastListener>();public Transmitter(MyGridProgram program){igc=program.IGC;blocks=new BlockArray<IMyRadioAntenna>(program,a=>{a.Radius=MIN_RANGE;a.EnableBroadcasting=true;a.Enabled=true;});igc.UnicastListener.SetMessageCallback();}public void Subscribe(string tag,Action<MyIGCMessage>fn,bool broadcast=false){if(broadcast){var listener=igc.RegisterBroadcastListener(tag);var listenerId=(DateTime.UtcNow.Ticks-(seq++)).ToString();listener.SetMessageCallback(listenerId);listeners[listenerId]=listener;}actions[tag]=fn;}public void Send<T>(string tag,T data,long?destination=null){blocks.ForEach(a=>a.Radius=MAX_RANGE);if(destination.HasValue){igc.SendUnicastMessage(destination.Value,tag,data);}else{igc.SendBroadcastMessage(tag,data);}blocks.ForEach(a=>a.Radius=MIN_RANGE);}public void Update(string listenerId,UpdateType updateSource){if(updateSource==UpdateType.IGC){IMyMessageProvider listener=igc.UnicastListener;if(listeners.ContainsKey(listenerId)){listener=listeners[listenerId];}while(listener.HasPendingMessage){var message=listener.AcceptMessage();if(actions.ContainsKey(message.Tag)){actions[message.Tag](message);}}}}}private static readonly HashSet<MyDetectedEntityType>gridTypes=new HashSet<MyDetectedEntityType>{MyDetectedEntityType.SmallGrid,MyDetectedEntityType.LargeGrid};IMyCameraBlock cam;IMyTextSurface lcdTarget;IMyTextSurface lcdIcbm;Transmitter tsm;MyDetectedEntityInfo?target;public Program(){var list1=new List<IMyCameraBlock>();GridTerminalSystem.GetBlocksOfType(list1);cam=list1.First();cam.EnableRaycast=true;var list2=new List<IMyCockpit>();GridTerminalSystem.GetBlocksOfType(list2);lcdTarget=list2.FirstOrDefault()?.GetSurface(0);lcdIcbm=list2.FirstOrDefault()?.GetSurface(3);tsm=new Transmitter(this);tsm.Subscribe(Transmitter.TAG_ICBM_STATE,UpdateIcbmState);Runtime.UpdateFrequency=UpdateFrequency.Update10;}public void UpdateIcbmState(MyIGCMessage message){Echo(message.Data.ToString());if(lcdIcbm!=null){lcdIcbm.WriteText(message.Data.ToString());}}public void UpdateTargetState(){if(lcdTarget!=null){if(target.HasValue){var dist=(target.Value.Position-cam.GetPosition()).Length();lcdTarget.WriteText($"{target.Value.Type}\ndist: {dist:0}m");}else{lcdTarget.WriteText("NO TARGET");}}}public void Main(string argument,UpdateType updateSource){tsm.Update(argument,updateSource);switch(argument){case"connect":tsm.Send(Transmitter.TAG_ICBM_CONNECT,string.Empty);break;case"shot":var entity=cam.Raycast(5000);if(gridTypes.Contains(entity.Type)){target=entity;}break;case"start":if(target.HasValue){tsm.Send(Transmitter.TAG_TARGET_POSITION,target.Value.Position);}break;case"reset":target=null;break;}UpdateTargetState();}